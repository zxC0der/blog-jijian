---
draft: true
---

> 第二部分分布式系统讲得挺好，作为入门普及材料。

## 分布式数据系统

### 5 数据复制

分布式系统的第一个特点就是在多台机器上保存相同数据副本，这就涉及到了数据复制的问题，通过数据复制，我们通常希望系统能达到以下目的:

- 数据在地理上更接近用户，降低访问延迟。
- 当部分机器组件出现故障，系统仍然可以工作，提高吞吐量。
- 可以拓展多台机器提供数据访问服务，从而提高吞吐量。

本章只讨论单台机器可以存储整个数据集(无需分区)，且数据是动态变化的情况。目前有三种流行的数据复制的方法: 主从复制，多主节点复制和无主节点复制。

#### 主从复制

主从结构通常包括一个主节点和多个从节点(副本)，工作原理如下:

- 所有写操作都由主节点来完成。
- 主节点写入数据后，将数据更改操作以日志或者其他形式发送给所有从节点，从节点严格按照顺序执行主节点的操作，同步数据。
- 读操作可以由主节点或者从节点来完成。

复制一个重要的可选项是同步复制或者异步复制。顾名思义，取决于主节点发送同步消息后是否需要等待从节点确认。

同步复制的优点是从节点一旦确认，就明确保证了数据和主节点同步，缺点是如果从节点因为种种原因无法完成确认，那么主节点会阻塞写操作直到同步成功。

因此把所有从节点都配置为同步复制是不实际的，在实践中，通常将一个从节点配置为同步，其他为异步，保证有两个节点拥有数据的最新副本，这种方式也称为半同步。

异步复制的缺点是如果复制未完成之前主节点发生故障，那么尚未复制的写请求就会丢失，即无法保证数据的持久化，而优点是复制时也可以快速响应写请求，系统吞吐量更好。

在添加新的从节点时，为了做到不停机，数据服务不中断的前提下完成新节点数据的复制，通常的操作逻辑是:

- 对主节点的数据产生一个快照并拷贝到从节点。
- 主节点向从节点发送在创建快照之后所发生的数据修改日志。
- 从节点应用这些日志对应的数据修改。
- 继续处理主节点上新的数据变化。

当某些节点发生故障出现中断，分布式系统的目的是要保证系统总体的持续运行，实现系统的高可用。

如果是从节点失效，只需要在节点重启后，向主节点请求故障前处理的最后的一次操作之后的日志，然后应用到本地追赶主节点。

如果是主节点失效，需要将一个从节点提升为主节点，同时客户端也需要更新，之后将所有写请求发送到新的主节点。切换的步骤可以由管理员手动进行，也可以自动进行，大概步骤如下:

- 确认主节点失效，通常采用基于超时的机制，节点之间频繁地发送心跳包。
- 选举新的主节点，通过选举(大多数节点同意)或者由控制节点来指定新的主节点，新的主节点最好与原主节点的数据差异最小。
- 重新配置系统使主节点失效，如果原主节点重新上线，要保证该节点被降级为从节点。

这个切换过程可能会发生很多意外，比如使用了异步复制，而被提升为主节点的从节点并未收到所有的数据，

#### 复制滞后问题

#### 多主节点复制

#### 无主节点复制